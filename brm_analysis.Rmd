---
title: "forager analyses"
output: html_document
date: "2022-10-14"
---
# import all packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggthemes)
library(lme4)
setwd(here::here())
getwd()
```

# psyrev data

```{r}
psyrev_switch = read_csv("data/psyrev_data/switch_results.csv")

psyrev_lexical = read_csv("data/psyrev_data/lexical_results.csv") %>%
  select(Subject, Fluency_Item, Semantic_Similarity, Phonological_Similarity) %>%
  rename(semantic = Semantic_Similarity,
         phonological = Phonological_Similarity)
  
```
## visualize cluster/switch designations
```{r}
psyrev_switch_sample = psyrev_switch %>% filter(Subject == 51 &
              Switch_Method %in% c("simdrop", "norms_associative", "norms_categorical",
                                   "delta_rise=0.0_fall=1.0",
                                   "multimodal_alpha=0.2") &
Fluency_Item %in% c("aardvark", "elephant", "flea", "ferret", "parrot", "hippopotamus")) %>%
  mutate(prev = lag(Fluency_Item),
         pair = paste(prev, Fluency_Item, sep = "-")) %>%
  left_join(psyrev_lexical) %>%
  pivot_longer(names_to = "type", cols = c(semantic, phonological)) %>%
  group_by(Switch_Method, type) %>%
  filter(Fluency_Item != "aardvark") %>%
  mutate(row = row_number(),
         Switch_Method = fct_recode(Switch_Method, multimodal = "multimodal_alpha=0.4",
                                     delta = "delta_rise=0.0_fall=1.0",
                                     simdrop = "simdrop",
                                     associative= "norms_associative",
                                    categorical = "norms_categorical"))%>%
  mutate(Switch_Method = fct_relevel(Switch_Method, "associative","categorical",  "simdrop", "delta", "multimodal"),
         Switch_Value = ifelse(Switch_Value == 1, "switch", "cluster"))%>%
  rename(method = Switch_Method,
         transition = Switch_Value)

clusterplot =psyrev_switch_sample %>%
  filter(method == "associative")%>%
  ggplot(aes(x = row, y = value, group= type, color = type)) +
  geom_line(aes(linetype = type))+
  facet_wrap(~method)+
  scale_color_stata()+
  geom_point(size = 4, aes(shape = type))+
  ggthemes::theme_few()+
  labs(x = "retrieval order", y = "similarity value")+
  theme(axis.title = element_text(face = "bold", size = rel(1)),
        strip.text= element_blank(),
          legend.title = element_text(face = "bold", size = rel(1)),
         plot.title = element_text(hjust = .5),
         axis.text.x = element_text(face = "bold", size = rel(1.2)))
  
ggsave('plots/switch.pdf', clusterplot)  
```

## compare model fits

```{r}
psyrev_models = read_csv("data/psyrev_data/model_results.csv")
psyrev_sum_nLL = psyrev_models %>% group_by(Model) %>%
  filter(Model %in% c("forage_static", "forage_dynamic_simdrop", "forage_dynamic_norms_associative",
                      "forage_dynamic_norms_categorical",
                      "forage_random_baseline")) %>%
  summarise(sum_nLL = sum(Negative_Log_Likelihood_Optimized)) %>%
  arrange(sum_nLL)

psyrev_sum_nLL
```



# sz data
```{r}
sz_individual_metrics = rbind(read_csv("data/sz_data/sz_mean/individual_descriptive_stats.csv") %>%
                        mutate(oov = "mean"),
                      read_csv("data/sz_data/sz_exclude/individual_descriptive_stats.csv") %>%
                        mutate(oov = "exclude"),
                      read_csv("data/sz_data/sz_truncate/individual_descriptive_stats.csv") %>%
                        mutate(oov = "truncate"))%>%
  rename(subject = Subject) %>%
  left_join( readxl::read_excel("data/sz_data/diagnostic_group_codes.xlsx"))%>%
  filter(!is.na(diagnostic_group))

sz_modeldata = rbind(read_csv("data/sz_data/sz_mean/model_results.csv") %>%
                       mutate(oov = "mean"),
                     read_csv("data/sz_data/sz_exclude/model_results.csv") %>%
                       mutate(oov = "exclude"),
                     read_csv("data/sz_data/sz_truncate/model_results.csv") %>%
                       mutate(oov = "truncate"))%>% 
  rename(subject = Subject) %>%
  left_join( readxl::read_excel("data/sz_data/diagnostic_group_codes.xlsx"))%>%
  filter(!is.na(diagnostic_group))
```

## basic descriptives

### number of items

```{r}

num_items = sz_individual_metrics %>% filter(!is.na(`#_of_Items`))%>%
  select(oov, diagnostic_group, subject, `#_of_Items`)

  
agg_items = sz_individual_metrics %>% filter(!is.na(`#_of_Items`))%>%
  group_by(oov, diagnostic_group)%>%
  summarise(ci = list(mean_cl_boot(`#_of_Items`) %>% 
                        rename(mean=y, lwr=ymin, upr=ymax))) %>% unnest
  
## model

num_items$diagnostic_group = as.factor(num_items$diagnostic_group)
contrasts(num_items$diagnostic_group) = contr.treatment(3, base = 3)

num_items$oov = as.factor(num_items$oov)
contrasts(num_items$oov) = contr.treatment(3, base = 3)

items_model = lm(data = num_items, `#_of_Items` ~ diagnostic_group*oov)

summary(items_model)
car::Anova(items_model)

emmeans::emmeans(items_model, 
                      pairwise ~ diagnostic_group,
                      adjust="tukey")

```


### use of lexical information
```{r}  

lexical_individual = sz_individual_metrics %>% filter(!is.na(`Semantic_Similarity_mean`))%>%
  select(oov, diagnostic_group, subject, 
         Semantic_Similarity_mean, Phonological_Similarity_mean, Frequency_Value_mean) %>%
  rename(semantic = Semantic_Similarity_mean, 
         frequency = Frequency_Value_mean,
         phonological = Phonological_Similarity_mean)%>%
  pivot_longer(names_to = "type", 
               cols=c(semantic, phonological,frequency)) %>%
  mutate(type = as.factor(type),
         diagnostic_group =as.factor(diagnostic_group),
         oov = as.factor(oov))

agg_lexical = lexical_individual %>%
  group_by(oov, diagnostic_group, type) %>%
  summarize(mean = round(mean(value),2),
            sd = round(sd(value),2)) %>%
  mutate(mean_sd = paste(mean, "(", sd, ")")) %>%
  select(-c(mean,sd)) %>%
  pivot_wider(names_from = type, values_from = mean_sd)

contrasts(lexical_individual$diagnostic_group) = contr.treatment(3, base = 3)
contrasts(lexical_individual$oov) = contr.treatment(3, base = 3)

freq_model = lm(data = lexical_individual %>% filter(type == "frequency"), 
           value ~ diagnostic_group*oov)
car::Anova(freq_model)

emmeans::emmeans(freq_model, 
                      pairwise ~ diagnostic_group,
                      adjust="tukey")


sem_model = lm(data = lexical_individual %>% filter(type == "semantic"), 
           value ~ diagnostic_group*oov)
car::Anova(sem_model)

phon_model = lm(data = lexical_individual %>% filter(type == "phonological"), 
           value ~ diagnostic_group*oov)
car::Anova(phon_model)
emmeans::emmeans(phon_model, 
                      pairwise ~ diagnostic_group,
                      adjust="tukey")
```

## number of switches

```{r}

sz_switch_metrics = sz_individual_metrics %>% 
  filter(Switch_Method %in% c("simdrop", "norms_associative", "norms_categorical")) %>%
  select(oov, subject, Switch_Method, Number_of_Switches, Cluster_Size_mean, Cluster_Size_std, diagnostic_group)


agg_switches = sz_switch_metrics %>%
  filter(Switch_Method == "simdrop") %>%
  group_by(oov, diagnostic_group) %>%
  summarise(mean = round(mean(Number_of_Switches),2),
            sd = round(sd (Number_of_Switches),2))%>%
  mutate(mean_sd = paste(mean, "(", sd, ")")) %>%
  select(-c(mean,sd))


## model

sz_switch_metrics$diagnostic_group = as.factor(sz_switch_metrics$diagnostic_group)
contrasts(sz_switch_metrics$diagnostic_group) = contr.treatment(3, base = 3)

sz_switch_metrics$oov = as.factor(sz_switch_metrics$oov)
contrasts(sz_switch_metrics$oov) = contr.treatment(3, base = 3)

switch_model_simdrop = lm(data = sz_switch_metrics %>% filter(Switch_Method == "simdrop") , 
                  Number_of_Switches ~ diagnostic_group*oov)
car::Anova(switch_model_simdrop)

emmeans::emmeans(switch_model_simdrop, 
                      pairwise ~ diagnostic_group,
                      adjust="tukey")
```



## mean cluster size

```{r}

agg_cluster_size = sz_switch_metrics %>%
  filter(Switch_Method == "simdrop") %>%
  group_by(oov, diagnostic_group) %>%
  summarise(mean = round(mean(Cluster_Size_mean),2),
            sd = round(sd (Cluster_Size_mean),2)) %>%
  mutate(mean_sd = paste(mean, "(", sd, ")")) %>%
  select(-c(mean,sd))


sz_switch_metrics$diagnostic_group = as.factor(sz_switch_metrics$diagnostic_group)
contrasts(sz_switch_metrics$diagnostic_group) = contr.treatment(3, base = 3)

sz_switch_metrics$oov = as.factor(sz_switch_metrics$oov)
contrasts(sz_switch_metrics$oov) = contr.treatment(3, base = 3)

cluster_size_model_simdrop = lm(data = sz_switch_metrics %>%
                                  filter(Switch_Method == "simdrop"), 
                                Cluster_Size_mean ~ diagnostic_group*oov)

car::Anova(cluster_size_model_simdrop)

cluster_size_model_associative = lm(data = sz_switch_metrics %>%
                                      filter(Switch_Method == "norms_associative"), 
                                    Cluster_Size_mean ~ diagnostic_group*oov)

car::Anova(cluster_size_model_associative)

emmeans::emmeans(cluster_size_model_associative, 
                      pairwise ~ diagnostic_group,
                      adjust="tukey")



```

## parameter values (betas)

```{r}
betas = sz_modeldata %>% select(oov, subject, diagnostic_group, Model, 
                               Beta_Frequency, Beta_Semantic, Beta_Phonological) %>%
  filter(Model %in% c("forage_dynamic_simdrop")) %>%
    pivot_longer(names_to = "beta", 
               cols=c(Beta_Frequency, Beta_Semantic, Beta_Phonological)) %>%
  separate(beta, into = c("beta1", "beta")) %>% select(-beta1) %>%
  filter(!is.na(value))

mean_betas = betas %>%
  group_by(oov, diagnostic_group, Model, beta) %>%
  summarise(ci = list(mean_cl_boot(value) %>% 
                        rename(mean=y, lwr=ymin, upr=ymax))) %>% unnest %>%
    mutate(mean = round(mean,2),
           lwr = round(lwr, 2), 
           upr = round(upr,2))%>%
    mutate(mean_ci = paste(mean, "(", lwr, "-", upr, ")")) %>%
    select(-c(mean, lwr, upr)) %>%
  pivot_wider(names_from = diagnostic_group, values_from = mean_ci )

## global cue salience model
beta_frequency_model = lm(data = betas %>% filter(beta == "Frequency"), 
                          value ~ diagnostic_group*oov)

car::Anova(beta_frequency_model)

emmeans::emmeans(beta_frequency_model, 
                      pairwise ~ diagnostic_group,
                      adjust="tukey")

## local cue salience model
beta_semantic_model = lm(data = betas %>% filter(beta == "Semantic"), 
                          value ~ diagnostic_group*oov)

car::Anova(beta_semantic_model)

emmeans::emmeans(beta_semantic_model, 
                      pairwise ~ diagnostic_group,
                      adjust="tukey")
```




